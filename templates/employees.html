{% extends 'base.html' %}

{% block content %}
<div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
    <div>
        <h2 class="text-3xl font-bold text-gray-800 tracking-tight">Employee Directory</h2>
        <p class="text-gray-500 mt-1 text-sm">View, manage, and update employee records.</p>
    </div>
    <button onclick="openModal()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2.5 rounded-lg shadow-md flex items-center gap-2 transition-all transform hover:-translate-y-0.5 font-medium text-sm">
        <i class="fa-solid fa-user-plus"></i> Add New Employee
    </button>
</div>

<div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200 mb-6 flex flex-col md:flex-row gap-4">
    <div class="flex-1 relative">
        <i class="fa-solid fa-search absolute left-4 top-3 text-gray-400"></i>
        <input type="text" id="searchInput" class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition text-sm" placeholder="Search by name, email, or mobile number...">
    </div>
    
    <div class="w-full md:w-64 relative">
        <i class="fa-solid fa-filter absolute left-4 top-3 text-gray-400"></i>
        <select id="filterDept" class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition text-sm bg-white cursor-pointer">
            <option value="">All Departments</option>
            <option value="IT">IT Development</option>
            <option value="HR">Human Resources</option>
            <option value="Sales">Sales & Marketing</option>
            <option value="Finance">Finance</option>
            <option value="Operations">Operations</option>
        </select>
    </div>
</div>

<div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
    <div class="overflow-x-auto">
        <table class="w-full text-left border-collapse">
            <thead class="bg-gray-50 border-b border-gray-200">
                <tr>
                    <th class="px-6 py-4 text-xs font-semibold text-gray-500 uppercase tracking-wider">ID</th>
                    <th class="px-6 py-4 text-xs font-semibold text-gray-500 uppercase tracking-wider">Employee Profile</th>
                    <th class="px-6 py-4 text-xs font-semibold text-gray-500 uppercase tracking-wider">Contact Info</th>
                    <th class="px-6 py-4 text-xs font-semibold text-gray-500 uppercase tracking-wider">Department</th>
                    <th class="px-6 py-4 text-xs font-semibold text-gray-500 uppercase tracking-wider">Attendance</th>
                    <th class="px-6 py-4 text-xs font-semibold text-gray-500 uppercase tracking-wider text-right">Actions</th>
                </tr>
            </thead>
            <tbody id="employeeTableBody" class="divide-y divide-gray-100 bg-white">
                </tbody>
        </table>
    </div>
    
    <div id="emptyState" class="hidden flex flex-col items-center justify-center p-12 text-center">
        <div class="bg-gray-50 p-4 rounded-full mb-4">
            <i class="fa-solid fa-users-slash text-3xl text-gray-400"></i>
        </div>
        <h3 class="text-lg font-medium text-gray-900">No employees found</h3>
        <p class="text-gray-500 text-sm mt-1">Try adjusting your filters or add a new employee.</p>
    </div>
</div>

<div id="modalOverlay" class="fixed inset-0 bg-gray-900/50 hidden z-50 flex items-center justify-center backdrop-blur-sm transition-opacity opacity-0" style="transition: opacity 0.3s ease;">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg p-0 transform scale-95 transition-transform duration-300" id="modalContent">
        
        <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-gray-50 rounded-t-2xl">
            <h3 class="text-lg font-bold text-gray-800" id="modalTitle">New Employee</h3>
            <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 transition p-1">
                <i class="fa-solid fa-xmark text-xl"></i>
            </button>
        </div>

        <div class="p-6">
            <form id="employeeForm" novalidate>
                <input type="hidden" id="dbId"> <div class="grid grid-cols-2 gap-4 mb-4">
                    <div class="group">
                        <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">Employee ID</label>
                        <input type="text" id="empId" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none text-sm transition" placeholder="E001">
                        <div id="msg-empId" class="mt-1 text-xs text-red-500 flex items-center gap-1 hidden"></div>
                    </div>
                    
                    <div class="group">
                        <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">Full Name</label>
                        <input type="text" id="empName" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none text-sm transition" placeholder="John Doe">
                        <div id="msg-empName" class="mt-1 text-xs text-red-500 flex items-center gap-1 hidden"></div>
                    </div>
                </div>

                <div class="mb-4 group">
                    <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">Email Address</label>
                    <div class="relative">
                        <i class="fa-solid fa-envelope absolute left-3 top-2.5 text-gray-400 text-sm"></i>
                        <input type="email" id="empEmail" class="w-full pl-9 pr-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none text-sm transition" placeholder="john@company.com">
                    </div>
                    <div id="msg-empEmail" class="mt-1 text-xs text-red-500 flex items-center gap-1 hidden"></div>
                </div>

                <div class="mb-4 group">
                    <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">Mobile Number</label>
                    <div class="relative">
                        <i class="fa-solid fa-phone absolute left-3 top-2.5 text-gray-400 text-sm"></i>
                        <input type="text" id="empMobile" class="w-full pl-9 pr-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none text-sm transition" placeholder="9876543210">
                    </div>
                    <div id="msg-empMobile" class="mt-1 text-xs text-red-500 flex items-center gap-1 hidden"></div>
                </div>

                <div class="mb-6 group">
                    <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">Department</label>
                    <div class="relative">
                        <i class="fa-solid fa-building absolute left-3 top-2.5 text-gray-400 text-sm"></i>
                        <select id="empDept" class="w-full pl-9 pr-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none text-sm bg-white cursor-pointer transition">
                            <option value="">Select Department...</option>
                            <option value="IT">IT Development</option>
                            <option value="HR">Human Resources</option>
                            <option value="Sales">Sales & Marketing</option>
                            <option value="Finance">Finance</option>
                            <option value="Operations">Operations</option>
                        </select>
                    </div>
                    <div id="msg-empDept" class="mt-1 text-xs text-red-500 flex items-center gap-1 hidden"></div>
                </div>

                <div class="flex gap-3 pt-2 border-t border-gray-100">
                    <button type="button" onclick="closeModal()" class="w-1/3 bg-white border border-gray-300 text-gray-700 py-2.5 rounded-lg hover:bg-gray-50 transition font-medium text-sm">Cancel</button>
                    <button type="submit" id="saveBtn" class="w-2/3 bg-indigo-600 text-white py-2.5 rounded-lg hover:bg-indigo-700 transition font-medium text-sm shadow-md flex justify-center items-center gap-2">
                        <span>Save Employee</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<div id="toast" class="fixed top-20 right-5 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg transform -translate-y-10 opacity-0 transition-all duration-300 flex items-center gap-3 z-50 pointer-events-none">
    <i id="toastIcon" class="fa-solid fa-circle-check text-green-400"></i>
    <span id="toastMessage">Action Successful</span>
</div>

{% endblock %}

{% block scripts %}
<script>
    const API_URL = '/api/employees/';
    let allEmployees = []; 

    const modalOverlay = document.getElementById('modalOverlay');
    const modalContent = document.getElementById('modalContent');
    const form = document.getElementById('employeeForm');

    function openModal(isEdit = false, data = null) {
        form.reset();
        document.querySelectorAll('[id^="msg-"]').forEach(el => el.classList.add('hidden'));
        document.querySelectorAll('input, select').forEach(el => el.classList.remove('border-red-500'));
        
        if (isEdit && data) {
            document.getElementById('modalTitle').innerText = 'Edit Employee';
            document.getElementById('dbId').value = data.id;
            document.getElementById('empId').value = data.employee_id;
            document.getElementById('empName').value = data.full_name;
            document.getElementById('empEmail').value = data.email;
            document.getElementById('empMobile').value = data.mobile_number || '';
            document.getElementById('empDept').value = data.department;
            
            document.getElementById('empId').disabled = true;
            document.getElementById('empId').classList.add('bg-gray-100', 'text-gray-500');
        } else {
            document.getElementById('modalTitle').innerText = 'New Employee';
            document.getElementById('dbId').value = '';
            document.getElementById('empId').disabled = false;
            document.getElementById('empId').classList.remove('bg-gray-100', 'text-gray-500');
        }

        modalOverlay.classList.remove('hidden');
        setTimeout(() => {
            modalOverlay.classList.remove('opacity-0');
            modalContent.classList.remove('scale-95');
            modalContent.classList.add('scale-100');
        }, 10);
    }

    function closeModal() {
        modalOverlay.classList.add('opacity-0');
        modalContent.classList.remove('scale-100');
        modalContent.classList.add('scale-95');
        setTimeout(() => {
            modalOverlay.classList.add('hidden');
        }, 300);
    }

    function showMessage(fieldId, type, text) {
        const msgDiv = document.getElementById(`msg-${fieldId}`);
        const input = document.getElementById(fieldId);
        
        if (type === 'error') {
            msgDiv.classList.remove('hidden');
            msgDiv.innerHTML = `<i class="fa-solid fa-circle-exclamation"></i> ${text}`;
            input.classList.add('border-red-500');
            input.classList.remove('border-gray-300');
        } else {
            msgDiv.classList.add('hidden');
            input.classList.remove('border-red-500');
            input.classList.add('border-gray-300');
        }
    }

    const validators = {
        empId: (val, currentId) => {
            if (val.trim().length === 0) return "ID is required.";
            const exists = allEmployees.some(e => e.employee_id.toLowerCase() === val.trim().toLowerCase() && e.id != currentId);
            if (exists) return "This Employee ID is already assigned.";
            return null;
        },
        
        empName: (val) => {
            if (val.trim().length === 0) return "Name is required.";
            if (val.trim().length < 3) return "Name must be > 3 characters.";
            if (!/^[a-zA-Z\s]+$/.test(val)) return "Name can only contain letters and spaces.";
            
            return null;
        },
        
        empEmail: (val, currentId) => {
            if (val.trim().length === 0) return "Email is required.";
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(val)) return "Invalid email format.";
            const exists = allEmployees.some(e => e.email.toLowerCase() === val.toLowerCase() && e.id != currentId);
            if (exists) return "This email is already in use.";
            return null;
        },

        empMobile: (val, currentId) => {
            if (!val) return null; 
            if (!/^\d{10}$/.test(val)) return "Must be exactly 10 digits.";
            const exists = allEmployees.some(e => e.mobile_number === val && e.id != currentId);
            if (exists) return "Mobile number already taken.";
            return null;
        },
        
        empDept: (val) => val ? null : "Please select a department."
    };

    ['empId', 'empName', 'empEmail', 'empMobile', 'empDept'].forEach(id => {
        document.getElementById(id).addEventListener('input', function() {
            const currentDbId = document.getElementById('dbId').value;
            const error = validators[id](this.value, currentDbId);
            
            if (error) {
                showMessage(id, 'error', error);
            } else {
                showMessage(id, 'success', ''); 
            }
        });
    });

    function renderTable(employeesToRender) {
        const tbody = document.getElementById('employeeTableBody');
        tbody.innerHTML = '';
        
        if (employeesToRender.length === 0) {
            document.getElementById('emptyState').classList.remove('hidden');
            return;
        }
        document.getElementById('emptyState').classList.add('hidden');

        employeesToRender.forEach(emp => {
            const initial = emp.full_name.charAt(0).toUpperCase();
            tbody.innerHTML += `
                <tr class="hover:bg-gray-50 transition border-b border-gray-50 last:border-0 group">
                    <td class="px-6 py-4 text-sm font-medium text-gray-500">${emp.employee_id}</td>
                    <td class="px-6 py-4">
                        <div class="flex items-center">
                            <div class="h-9 w-9 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center font-bold text-sm mr-3 shadow-sm">
                                ${initial}
                            </div>
                            <div>
                                <div class="text-sm font-semibold text-gray-900">${emp.full_name}</div>
                                <div class="text-xs text-gray-400">Added: ${new Date(emp.created_at).toLocaleDateString()}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="text-xs text-gray-600 flex flex-col gap-1">
                            <span class="flex items-center gap-2"><i class="fa-regular fa-envelope text-gray-400"></i> ${emp.email}</span>
                            <span class="flex items-center gap-2"><i class="fa-solid fa-mobile-screen text-gray-400"></i> ${emp.mobile_number || 'N/A'}</span>
                        </div>
                    </td>
                    <td class="px-6 py-4">
                        <span class="px-2.5 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-50 text-blue-700 border border-blue-100">
                            ${emp.department}
                        </span>
                    </td>
                    <td class="px-6 py-4">
                        <span class="px-2.5 py-1 inline-flex text-xs font-medium rounded-full bg-emerald-50 text-emerald-700 border border-emerald-100">
                            <i class="fa-solid fa-medal mr-1.5 mt-0.5"></i> ${emp.total_present_days} Days Present
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <div class="flex items-center justify-end gap-2">
                            <button onclick='editEmployee(${JSON.stringify(emp).replace(/'/g, "&#39;")})' class="text-indigo-500 hover:text-indigo-700 p-2 transition bg-indigo-50 hover:bg-indigo-100 rounded-lg focus:ring-2 focus:ring-indigo-300 outline-none" title="Edit">
                                <i class="fa-solid fa-pen-to-square"></i>
                            </button>
                            <button onclick="deleteEmployee(${emp.id})" class="text-red-400 hover:text-red-600 p-2 transition bg-red-50 hover:bg-red-100 rounded-lg focus:ring-2 focus:ring-red-300 outline-none" title="Delete">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        });
    }

    function applyFilters() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const deptFilter = document.getElementById('filterDept').value;

        const filteredData = allEmployees.filter(emp => {
            const matchesSearch = 
                emp.full_name.toLowerCase().includes(searchTerm) ||
                emp.email.toLowerCase().includes(searchTerm) ||
                (emp.mobile_number && emp.mobile_number.includes(searchTerm));
            
            const matchesDept = deptFilter === "" || emp.department === deptFilter;

            return matchesSearch && matchesDept;
        });

        renderTable(filteredData);
    }

    document.getElementById('searchInput').addEventListener('input', applyFilters);
    document.getElementById('filterDept').addEventListener('change', applyFilters);


    function showToast(msg, type = 'success') {
        const toast = document.getElementById('toast');
        const icon = document.getElementById('toastIcon');
        const text = document.getElementById('toastMessage');

        text.innerText = msg;
        if (type === 'error') {
            icon.className = "fa-solid fa-circle-xmark text-red-400";
        } else {
            icon.className = "fa-solid fa-circle-check text-green-400";
        }

        toast.classList.remove('-translate-y-10', 'opacity-0');
        setTimeout(() => toast.classList.add('-translate-y-10', 'opacity-0'), 3000);
    }

    async function loadEmployees() {
        try {
            const response = await fetch(API_URL);
            allEmployees = await response.json(); 
            applyFilters(); 
        } catch (error) {
            console.error(error);
        }
    }

    function editEmployee(data) {
        openModal(true, data);
    }

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const dbId = document.getElementById('dbId').value;
        const ids = ['empId', 'empName', 'empEmail', 'empMobile', 'empDept'];
        let hasError = false;

        ids.forEach(id => {
            const val = document.getElementById(id).value;
            const err = validators[id](val, dbId);
            if (err) {
                showMessage(id, 'error', err);
                hasError = true;
            }
        });

        if (hasError) return;

        const data = {
            employee_id: document.getElementById('empId').value,
            full_name: document.getElementById('empName').value,
            email: document.getElementById('empEmail').value,
            mobile_number: document.getElementById('empMobile').value,
            department: document.getElementById('empDept').value
        };

        const isEdit = !!dbId;
        const url = isEdit ? `${API_URL}${dbId}/` : API_URL;
        const method = isEdit ? 'PUT' : 'POST';

        try {
            const res = await fetch(url, {
                method: method,
                headers: { 
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify(data)
            });

            if (res.ok) {
                closeModal();
                showToast(isEdit ? 'Employee record updated successfully.' : 'New employee added successfully.');
                loadEmployees();
            } else {
                const errData = await res.json();
                showToast("Failed to save employee data.", "error");
                if(errData.employee_id) showMessage('empId', 'error', errData.employee_id[0]);
                if(errData.email) showMessage('empEmail', 'error', errData.email[0]);
                if(errData.mobile_number) showMessage('empMobile', 'error', errData.mobile_number[0]);
            }
        } catch (err) {
            showToast("Server connection error.", "error");
        }
    });

    async function deleteEmployee(id) {
        if(confirm("Are you sure you want to delete this record? This action cannot be undone.")) {
            await fetch(`${API_URL}${id}/`, { method: 'DELETE' });
            showToast('Employee record deleted.', 'success');
            loadEmployees();
        }
    }

    loadEmployees();
</script>
{% endblock %}